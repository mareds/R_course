---
title       : Data Analysis with R
subtitle    : 16 - String manipulation and regular expressions
author      : Saskia A. Otto
job         : Postdoctoral Researcher
framework   : io2012        
highlighter : highlight.js 
hitheme     : sao_theme     
widgets     : [mathjax, quiz, bootstrap, interactive] 
mode        : selfcontained 
knit        : slidify::knit2slides
logo        : uham_logo.png
biglogo     : BigLogo_MDS.png
assets      : {assets: ../../assets}
--- &slide_no_footer .segue bg:#1874CD

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy=FALSE, warning=FALSE, message=FALSE, cache=FALSE, dev.args=list(bg="transparent"),    
fig.retina = 2, fig.path = "lecture16_plotting_files/")
knitr::knit_hooks$set(output = function(x, options) {
  if (knitr:::output_asis(x, options)){
   return(x)
  }
  stringr::str_c('\n\n```no-highlight\n', x, '```\n\n')
})
```

```{r data, echo = FALSE}
library(tidyverse)
```

# Strings in R
<img src="img/Data_science_1a.png" style="height:150px;border:0;position: absolute; left: 900px; top: 50px" </img> 

---
## What is a string again? 

- Any value written within a **pair of** single quote or **double quotes** in R is treated as a string and stored in a **character vector** (within double quotes). 
- Lets look at a famous quote made by Albert Einstein:

```{r}
einstein <- c("The difference", "between stupidity", 
  "and genius is that", "genius has its limits.")
```

<small> â†’ The character vector `einstein` contains 4 elements or more precisely **4 strings**.</small>

---
## Manipulation of strings 
- R may not be as rich and diverse as other scripting languages when it comes to string manipulation, but it can take you very far if you know how.
- This tutorial gives you only a short introduction into some functions for basic manipulations.  
- Some of these functions require **regular expressions** (*regex* or *regexpr* in short ), which are a concise **language for describing patterns in strings** that typically contain unstructured or semi-structured data.
- To learn more about regex I recommend the excellent website [http://www.regular-expressions.info](http://www.regular-expressions.info). It contains many different topics, resources, examples, and tutorials at both beginner and advanced levels.

---
## Manipulation of strings 
Even if you don't plan to do text analysis, text mining, or natural language processing, it is useful to have some knowledge on handling and processing strings in R for the following reasons:

---

- Your dataset most likely will contain some text, e.g. stations names, species names, etc.
  - you might want to **remove a given character** in the names of your variables or in the entire dataset
  - you might want to **convert labels** to upper case (or lower case)
  - you might want to **replace** an **outdated species names** with the new name
  - you might want to **re-classify** certain categories, e.g. group different life stages together
  - you want to **abbreviate names**
  

---

- Your dataset most likely will contain some text, e.g. stations names, species names, etc.
  - you might want to **remove a given character** in the names of your variables or in the entire dataset
  - you might want to **convert labels** to upper case (or lower case)
  - you might want to **replace** an **outdated species names** with the new name
  - you might want to **re-classify** certain categories, e.g. group different life stages together
  - you want to **abbreviate names**  
- You want to **extract data** from the web (**web-scraping**) and remove irrelevant information.
- You want to **remove** all unnecessary **metadata** that your imported dataset contains.
- You want to **iterate** the data import and processing for 100 data files that have slightly different file names.


---
## Some useful base functions 

```{r, echo=FALSE, out.width = "500px", fig.align='center'}
knitr::include_graphics("img/Base_string_functions.png")
```

---
## Some useful base functions 

```{r, echo=FALSE, out.width = "500px", fig.align='center'}
knitr::include_graphics("img/Base_string_functions.png")
```

<small> Most of the times these functions are enough and they will allow you to get your job done. However, they have some drawbacks when it comes to **handling NAs** or pasting elements with **zero length**.

A **nice package** that solves these problems and provides several functions for carrying out consistent string processing comes again from **tidyverse**... </small>

---
## The *stringr* package 

<div style="position: absolute; left: 950px; top: 25px; z-index:100">
    <img src="img/Logo_stringr.png" alt="" width=75px height=75px>
</div>

- *stringr* adds more functionality to the base functions for handling strings in R.
- In *stringr*,
  - **argument names** (and positions) are **consistent**, 
  - all functions deal with **NA's** and **zero length** character appropriately, and  
  - the **output** data structures from each function **matches the input** data structures of **other functions**
  - all functions start with `str_` so you can quickly select the appropriate one from the dropdown list displayed by R Studio 
- to access these function load stringr or tidyverse:

```{r, eval=FALSE}
library(stringr)
library(tidyverse)
```  

--- 
## A quick comparison of *base* and *stringr* functions

```{r, echo=FALSE, out.width = "850px", fig.align='center'}
knitr::include_graphics("img/Base_vs_stringr.png")
```

--- &twocol
## A quick comparison of *base* and *stringr* functions

```{r, echo=FALSE, out.width = "850px", fig.align='center'}
knitr::include_graphics("img/Base_vs_stringr.png")
```

*** =left
```{r}
x <- c("Shark", "Whale", "Ray")
str_length(x)
```
*** =right
```{r}
str_to_lower(x)
str_to_upper(x)
```


--- &vcenter
## Combining and subsetting strings using *stringr* 

```{r, echo=FALSE, eval=FALSE}
# only for keynote slide
a <- "Gadus"
b <- "morhua"
ab <- str_c(a, b, sep = " ")
a_split <- str_sub(ab, 1, 5) 
b_split <- str_sub(ab, -6, -1) 
```

```{r, echo=FALSE, out.width = "700px", fig.align='center'}
knitr::include_graphics("img/Combine_strings.png")
```

--- 
## Combining with `str_c()`

```{r}
# Args 'sep' for strings of DIFFERENT vectors
str_c("a", "b", sep = "<") 

# Args 'collapse' for strings within the SAME vector
str_c(c("a","b"), collapse = "-") 

# Both args for doing both (first sep, than collapse applied)
str_c(c("a","b"), c(1,2), sep = "<", collapse = "-") 

# The recycling rule also applies here:
str_c("a", 1:10, sep = "_") 
```


--- 
## Subsetting with `str_sub()`

```{r}
x <- c("Shark", "Whale", "Ray")
str_sub(string = x, start = 1, end = 3) # extract 1st to 3rd
str_sub(string = x, end = 1) # extract 1st
str_sub(x, -1) # extract last using negative index

# Replacing values in each string with str_sub
str_sub(x, 1, 1) <- "A"; x

# Combine str_sub with str_to_upper 
str_sub(x, -1) <- str_to_upper(str_sub(x, -1)); x
```


---
## Other useful *stringr* functions (1)

`str_sort()` and `str_order()`: sort character vectors using the current locale (= ISO 639 language code)
```{r}
x <- c("Shark", "Whale", "Ray")
str_sort(x) # returns sorted character vector
str_order(x) # returns index vector of sorted strings
```

---
## Other useful *stringr* functions (2)

`str_trim()`: removes whitespace from start and end of string
```{r}
str_trim("  String with trailing and leading white space\t")
```
<br>
`str_pad()`: adds single padding character (default is whitespace)
(args 'width' indicates the total string length INCLUDING the existing characters)
```{r}
str_pad("a", width = 5, side = "both") 
str_pad("a", 6, "both", pad = "-")
```

---
## Other useful *stringr* functions (3)

`str_wrap()`: wrap strings into formatted paragraphs (based on a specific algorithm)
```{r}
x <- "This is a wrapper around stri_wrap which implements a wrapping algorithm."
str_wrap(x, width=10)
cat(str_wrap(x, width=10))
```


---
## Functions for pattern matching in *stringr*

```{r, echo=FALSE, eval=FALSE}
# just for the keynote slide
library(stringr)
string <- c("The difference", "between stupidity", "and genius is that", "genius has its limits.")
pattern <- c(".en")
replacement <- c("XXX")

str_detect(string, pattern)

str_locate(string, pattern) 
str_locate_all(string, pattern) 

str_extract(string, pattern)
str_extract_all(string, pattern) 
str_extract_all(string, pattern, simplify = TRUE) 
str_match(string, pattern) 
str_match_all(string, pattern)

str_replace(string, pattern, replacement) 
str_replace_all(string, pattern, replacement) 

str_split(string, pattern)
```

--- &slide_no_footer .segue

```{r, echo=FALSE, out.width = "900px", fig.align='center'}
knitr::include_graphics("img/Pattern_matching.png")
```

---
## Overview of regular expressions

<div class="img-with-text" style="position: absolute; left: 150px; top: 120px; z-index:100">
    <img src="img/Overview_regex.png" alt="B Taylor" width=800px />
 <p><span class="source-img" style = "float:right">
    Adapted from the <a href='https://www.rstudio.com/wp-content/uploads/2016/09/RegExCheatsheet.pdf' title=''>RegEx cheatsheet</a> by Ian Kopacka</span></p>
</div>


---
## Some examples: `str_detect()` (1)

Identify strings that match a specific pattern:

```{r}
x <- c("shark", "whale shark", "whale", "manta ray", "sting ray")	
```

Specific pattern using **anchors**:

```{r}
str_detect(x, "^w") # ^ = start of string
str_detect(x, "y$") # $ = end of string
str_detect(x, "whale") # all strings that contain that word
str_detect(x, "^whale$") # all strings that start end end with this word
```

---
## Some examples: `str_detect()` (2)

Identify strings that match a specific pattern:

```{r}
x <- c("shark", "whale shark", "whale", "manta ray", "sting ray")	
```

Specific pattern using **character classes**:

```{r}
# Start with a vowel (same as "^[a,e,i,u,o]")
str_detect(string = x, pattern = "^(a|e|i|u|o)") 
# End with 'ark' or 'ale'
str_detect(x, pattern = "(ark|ale)$")
# Contains any character, then 'a', then whitespace
str_detect(x, pattern = ".a ")
```


---
## Some examples: `str_subset()`

Subset strings that match a specific pattern using `str_detect()` for indexing or the **wrapper function** `str_subset()`:

```{r}
x <- c("shark", "whale shark", "whale", "manta ray", "sting ray")	
```

```{r}
# Get all strings in x that start with 'm' or end with 'k'
x[str_detect(x, "^m|k$")] 
# same as
str_subset(x, "^m|k$")
```

---
## Some examples: `str_split()` (1)

Split a string into pieces based on a specific pattern:

```{r}
x <- c("shark", "whale shark", "whale", "manta ray", "sting ray")	
str_split(x, " ", simplify = TRUE)
```

---
## Some examples: `str_split()` (2)

Split a string into pieces based on a specific pattern:

```{r}
fruits <- c("apples and oranges and pears and bananas",
  "pineapples and mangos and guavas")

str_split(fruits, " and ", simplify = TRUE)

# Specify n to restrict the number of possible matches
str_split(fruits, " and ", n = 2, simplify = TRUE)
```

--- &slide_no_footer .segue bg:#EEC900

# Your turn...

--- &exercise
*stringr* provides a dataset (vector) called `words`, which contains a selection of 980 words: 

```{r}
stringr::words
```

```{r, echo =FALSE}
x <- stringr::words
```

--- &multitext bg:#EEC900
# Quiz 1: Detect pattern

Now tell me,

1. how many words are longer than 10 characters?
2. how many words are exactly 2 letters long?
3. how many words start end with *p*?

*** .hint
<small>For 1. Use `str_length()` and then filter.   
For 2. and 3. use `str_detect()` with anchors and the 'any character' regex and then sum up.</small>

*** .explanation
Solution code:   
`x %>% str_length() %>% .[.>10] %>% length()`   
`str_detect(x, "^..$") %>% sum()`     
`str_detect(x, "p$") %>% sum()`     

1. <span class='answer'>`r x %>% str_length() %>% .[.>10] %>% length()`</span>
2. <span class='answer'>`r str_detect(x, "^..$") %>% sum()`</span>
3. <span class='answer'>`r str_detect(x, "p$") %>% sum()`</span>


--- &multitext bg:#EEC900
# Quiz 2: Detect pattern and split strings

1. How many of the 3-letter words start with a consonant?
2. How many words contain 'ee' (as in street)?
3. If you subset all words that contain the pattern 'st' and than split these words by this pattern, how many strings do you get in total?

*** .hint
<small>For 1: List in your pattern all vowels but use the negation: `[^]`   
For 2: Use the quantifier for matching exactly n times.   
For 3: You could subset with `str_subset()`, split with `str_split()`, unlist the returned list and then get the length of the obtained vector.</small>

*** .explanation
Solution code:   
`str_detect(x, "^[^a,e,i,u,o]..$") %>% sum()`    
`str_detect(x, "e{2,}") %>% sum()`  
`str_subset(x, "st") %>% str_split("st") %>% unlist() %>% length()`  

1. <span class='answer'>`r str_detect(x, "^[^a,e,i,u,o]..$") %>% sum()`</span>
2. <span class='answer'>`r str_detect(x, "e{2,}") %>% sum()`</span>
3. <span class='answer'>`r str_subset(x, "st") %>% str_split("st") %>% unlist() %>% length()`</span>


--- &exercise
# Quiz 3: Subsetting and combining strings

You have the following vector `x`:

```{r}
x <- c("file_001.csv", "file_002.csv", "file_003.csv", "file_004.csv", "file_005.csv",
  "file_006.csv", "file_007.csv", "file_008.csv", "file_009.csv", "file_010.csv")
```

1. How can you remove the first 1 or 2 zeros?   
2. How could you generate yourself such vector but with 100 elements ("file_1.csv" ... "file_100.csv")?

--- bg:#CD2626
# Solution

```{r}
# 1.You could replace first the '_00' by the underscore and then all remaining '_0'
x %>% str_replace("_00", "_") %>% str_replace("_0", "_")

# 2. Simply take advantage of the recycling rule when using str_c()
x <- str_c("file_", 1:100, ".csv", sep = "")
x[1:15]
```



--- &slide_no_footer .segue bg:#E5E5E5

## Overview of functions you learned today

base functions:    
`paste()`, `toupper()`, `tolower()`, `nchar()`, `grep()`, `gsub()` 

stringr functions:   
`str_c()`, `str_to_upper()`, `str_to_lower()`, `str_length()`, `str_sub()`  
`str_sort()`, `str_order()`, `str_trim()`, `str_pad()`, `str_wrap()`  
`str_detect()`, `str_subset()`, `str_locate()`, `str_locate_all()`,  
`str_extract()`, `str_extract_all()`, `str_match()`, `str_match_all()`,   
`str_replace()`, `str_replace_all()`, `str_split()`



--- &slide_no_footer .segue bg:#CD2626

# How do you feel now.....?

--- &vcenter

## Totally confused?
                
```{r, out.width = "400px", echo = FALSE, fig.align = 'center'}
knitr::include_graphics("img/Comic_confused.png")
```

[Chapter 14 on strings](http://r4ds.had.co.nz/strings.html) is worth reading with good exercises to practise regular expressions as well as the website [http://www.regular-expressions.info](http://www.regular-expressions.info).
See also the [stringr cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/strings.pdf) for a function overview.

--- &vcenter

## Totally bored?
                
```{r, out.width = "800px", echo = FALSE, fig.align = 'left'}
knitr::include_graphics("img/Comic_bored.png")
```

Keep on working on your case study!

---

## Totally content?
Then go grab a coffee, lean back and enjoy the rest of the day...!

```{r, out.width = "600px", echo = FALSE, fig.align = 'center'}
knitr::include_graphics("img/Comic_hammock.png")
```



--- &thankyou
